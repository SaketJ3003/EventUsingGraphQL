<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900 font-sans">
    <nav class="border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
            <h1 class="text-3xl font-mono tracking-tight"><a href="/events/" class="hover:text-gray-600 transition">EVENTS</a></h1>
        </div>
    </nav>
    
    <div class="max-w-7xl mx-auto px-6 py-12">
        <div class="flex items-center justify-center min-h-[calc(100vh-200px)]">
            <div class="w-full max-w-md bg-gray-50 border border-gray-200 rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">Login to your Account</h2>
                
                <div id="successMessage" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-green-800 text-sm" id="successText"></p>
                </div>
                
                <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-red-800 text-sm" id="errorText"></p>
                </div>

                <form id="loginForm" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                            Email <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="email" 
                            name="email"
                            class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter your email"
                        >
                        <small class="text-red-500 hidden" id="email-error"></small>
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                            Password <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter your password"
                        >
                        <small class="text-red-500 hidden" id="password-error"></small>
                    </div>

                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="w-full mt-6 px-4 py-2 bg-blue-600 text-white font-medium rounded-full hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        Login
                    </button>
                </form>

                <p class="text-center text-sm text-gray-600 mt-6">
                    Don't have an account? 
                    <a href="/signup/" class="text-blue-600 hover:underline">Sign up here</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        async function graphqlFetch(query, variables = {}, token = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `JWT ${token}`;
            const res = await fetch('/graphql/', {
                method: 'POST',
                headers,
                body: JSON.stringify({ query, variables })
            });
            return res.json();
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            document.querySelectorAll('[id$="-error"]').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            const email    = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const data = await graphqlFetch(`
                    mutation Login($email: String!, $password: String!) {
                        login(email: $email, password: $password) {
                            success
                            message
                            accessToken
                            refreshToken
                            user {
                                id
                                username
                                isStaff
                                isSuperuser
                            }
                        }
                    }
                `, { email, password });

                console.log('GraphQL response:', data);

                if (data.errors) {
                    document.getElementById('errorText').textContent = data.errors[0].message;
                    document.getElementById('errorMessage').classList.remove('hidden');
                    return;
                }

                const result = data.data.login;

                if (result.success) {
                    localStorage.setItem('access_token', result.accessToken);
                    localStorage.setItem('refresh_token', result.refreshToken);

                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';

                    const successMsg  = document.getElementById('successMessage');
                    const successText = document.getElementById('successText');
                    const isAdmin = result.user && (result.user.isStaff || result.user.isSuperuser);

                    successText.textContent = isAdmin
                        ? 'Login successful! Redirecting to Admin Dashboard...'
                        : 'Login successful! Redirecting...';
                    successMsg.classList.remove('hidden');

                    setTimeout(() => {
                        window.location.href = isAdmin
                            ? '/admin-panel/dashboard/'
                            : '/events/';
                    }, 1000);
                } else {
                    document.getElementById('errorText').textContent = result.message || 'Login failed.';
                    document.getElementById('errorMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorText').textContent = 'Network error. Please try again.';
                document.getElementById('errorMessage').classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });
    </script>
</body>
</html>
